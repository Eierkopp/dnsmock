#!/usr/bin/python3
# -*- coding: utf-8 -*-

import asyncio
import logging
import dnsmock

logging.basicConfig(level=logging.DEBUG)
log = logging.getLogger


async def setup():
    loop.set_debug(config.getboolean("global", "debug"))

    mocks.start()
    await client.start()
    await server.start(mocks, client)
    await http_server.start(mocks)


async def shutdown():
    await http_server.stop()
    await server.stop()
    await client.stop()
    mocks.stop()


loop = asyncio.new_event_loop()
config = dnsmock.config
mocks = dnsmock.Mocks(config)
client = dnsmock.DNS_Client(config)
server = dnsmock.DNS_Server(config)
http_server = dnsmock.HttpServer(config)

try:
    loop.run_until_complete(setup())
    print("======== Running ========\n"
          "(Press CTRL+C to quit)")
    loop.run_forever()
except KeyboardInterrupt:
    pass
except Exception:
    log(__name__).error("Error running dnsmock", exc_info=True)

loop.run_until_complete(shutdown())

loop.close()
